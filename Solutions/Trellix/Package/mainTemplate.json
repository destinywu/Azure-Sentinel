{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Trellix"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "_solutionName": "Trellix",
    "_solutionVersion": "3.0.0",
    "solutionId": "azuresentinel.azure-sentinel-solution-trellix",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "3.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "TrellixConnector",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "TrellixConnectorConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "parserObject1": {
      "_parserName1": "[concat(parameters('workspace'),'/','TrellixEvents')]",
      "_parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'TrellixEvents')]",
      "parserTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring('TrellixEvents-Parser')))]",
      "parserVersion1": "1.0.0",
      "parserContentId1": "TrellixEvents-Parser"
    },
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "Trellix Endpoint Security (via Codeless Connector Framework)",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "TrellixConnector",
                  "title": "Trellix Endpoint Security (via Codeless Connector Framework)",
                  "publisher": "Microsoft",
                  "descriptionMarkdown": "The [Trellix Endpoint Security](https://www.trellix.com/) data connector enables you to ingest security events from Trellix ePO (ePolicy Orchestrator) into Microsoft Sentinel. This connector uses OAuth2 client credentials authentication and automatically handles pagination to collect comprehensive endpoint security data including threat detections, analyzer information, source and target system details, and threat response actions.",
                  "graphQueriesTableName": "TrellixEvents",
                  "graphQueries": [
                    {
                      "metricName": "Trellix events",
                      "legend": "Trellix ePO Events",
                      "baseQuery": "TrellixEvents"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "All Trellix events",
                      "query": "{{graphQueriesTableName}}\n| sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "TrellixEvents",
                      "lastDataReceivedQuery": "TrellixEvents\n| where TimeGenerated > ago(6h)\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    },
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "TrellixEvents | where TimeGenerated > ago(1h) | take 1"
                      ]
                    }
                  ],
                  "availability": {
                    "isPreview": true,
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true,
                          "action": false
                        }
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. API Configuration",
                      "description": "Configure your Trellix ePO API connection.",
                      "instructions": [
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "API Base URL",
                            "placeholder": "https://api.manage.trellix.com",
                            "type": "text",
                            "name": "trellixApiBaseUrl",
                            "validations": {
                              "required": true
                            }
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "## Authentication\n\nProvide your API key for authentication. This will be sent in the x-api-key header."
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "API Key",
                            "placeholder": "Enter your API key",
                            "type": "password",
                            "name": "apiKey",
                            "validations": {
                              "required": true
                            }
                          }
                        },
                        {
                          "type": "InfoMessage",
                          "parameters": {
                            "text": "The API key will be securely stored and used for authentication with the Trellix ePO API.",
                            "visible": true,
                            "inline": true
                          }
                        }
                      ]
                    },
                    {
                      "title": "2. Authentication Configuration",
                      "description": "Configure OAuth2 authentication credentials.",
                      "instructions": [
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Token endpoint",
                            "placeholder": "https://iam.cloud.trellix.com/iam/v1.0/token",
                            "type": "text",
                            "name": "trellixAuthTokenUrl",
                            "validations": {
                              "required": true
                            }
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "### OAuth2 Configuration\nConfigure OAuth2 client credentials for API access. Read about the Trellix API authorization model at https://developer.manage.trellix.com/public/mvision/docs/umam"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Client ID",
                            "placeholder": "Your client ID",
                            "type": "text",
                            "name": "clientId",
                            "validations": {
                              "required": true
                            }
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Client Secret",
                            "placeholder": "Your client secret",
                            "type": "password",
                            "name": "clientSecret",
                            "validations": {
                              "required": true
                            }
                          }
                        },
                        {
                          "type": "InfoMessage",
                          "parameters": {
                            "text": "OAuth2 authentication provides secure access to your API endpoints.",
                            "visible": true,
                            "inline": true
                          }
                        }
                      ]
                    },
                    {
                      "title": "3. Enable Connector",
                      "description": "Activate the Trellix Endpoint Security connector",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "### Connector Activation\n\nReview your configuration and enable the connector to start collecting security events."
                          }
                        },
                        {
                          "type": "ConnectionToggleButton",
                          "parameters": {
                            "connectLabel": "Connect Trellix Endpoint Security",
                            "disconnectLabel": "Disconnect Connector",
                            "name": "mainToggle"
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "### Post-Connection\n\nAfter connecting, monitor the connector status in the **Data connectors** page. Data should begin appearing within 5-10 minutes."
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "TrellixDCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "streamDeclarations": {
                  "Custom-TrellixEvents_CL": {
                    "columns": [
                      {
                        "name": "id",
                        "type": "string"
                      },
                      {
                        "name": "type",
                        "type": "string"
                      },
                      {
                        "name": "attributes",
                        "type": "dynamic"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-TrellixEvents_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "outputStream": "Custom-TrellixEvents_CL",
                    "transformKql": "source  | project TimeGenerated=now(),Id=tostring(id),EventType=tostring(type),AutoGuid=tostring(attributes.autoguid),DetectedUtc=datetime(1970-01-01)+(tolong(attributes.detectedutc)*1ms),ReceivedUtc=datetime(1970-01-01)+(tolong(attributes.receivedutc)*1ms),AgentGuid=tostring(attributes.agentguid),Analyzer=tostring(attributes.analyzer),AnalyzerName=tostring(attributes.analyzername),AnalyzerVersion=tostring(attributes.analyzerversion),AnalyzerHostName=tostring(attributes.analyzerhostname),AnalyzerIPv4=tostring(attributes.analyzeripv4),AnalyzerIPv6=tostring(attributes.analyzeripv6),AnalyzerMac=tostring(attributes.analyzermac),AnalyzerDatVersion=tostring(attributes.analyzerdatversion),AnalyzerEngineVersion=tostring(attributes.analyzerengineversion),AnalyzerDetectionMethod=tostring(attributes.analyzerdetectionmethod),SourceHostName=tostring(attributes.sourcehostname),SourceIPv4=tostring(attributes.sourceipv4),SourceIPv6=tostring(attributes.sourceipv6),SourceMac=tostring(attributes.sourcemac),SourceUserName=tostring(attributes.sourceusername),SourceProcessName=tostring(attributes.sourceprocessname),SourceUrl=tostring(attributes.sourceurl),TargetHostName=tostring(attributes.targethostname),TargetIPv4=tostring(attributes.targetipv4),TargetIPv6=tostring(attributes.targetipv6),TargetMac=tostring(attributes.targetmac),TargetUserName=tostring(attributes.targetusername),TargetPort=tostring(attributes.targetport),TargetProtocol=tostring(attributes.targetprotocol),TargetProcessName=tostring(attributes.targetprocessname),TargetFileName=tostring(attributes.targetfilename),ThreatCategory=tostring(attributes.threatcategory),ThreatEventId=toint(attributes.threateventid),ThreatSeverity=tostring(attributes.threatseverity),ThreatName=tostring(attributes.threatname),ThreatType=tostring(attributes.threattype),ThreatActionTaken=tostring(attributes.threatactiontaken),ThreatHandled=tobool(attributes.threathandled),Timestamp=todatetime(attributes.timestamp),NodePath=tostring(attributes.nodepath),TargetHash=tostring(attributes.targethash)"
                  }
                ]
              }
            },
            {
              "name": "TrellixEvents_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "retentionInDays": 180,
                "categories": [
                  "security"
                ],
                "artifactVersion": 1,
                "intelligencePacks": [
                  "SecurityInsights"
                ],
                "isResourceCentric": false,
                "tableState": "Validation",
                "isTroubleshootingAllowed": true,
                "isLakeAllowed": true,
                "schema": {
                  "name": "TrellixEvents_CL",
                  "description": "Trellix Endpoint Security events data collected from the Trellix ePO events API.",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime",
                      "description": "The timestamp (in UTC) when the event was generated.",
                      "isDefaultDisplay": true
                    },
                    {
                      "name": "Id",
                      "type": "string",
                      "description": "Identifier of the event."
                    },
                    {
                      "name": "EventType",
                      "type": "string",
                      "description": "Type of the event provided by Trellix."
                    },
                    {
                      "name": "AutoGuid",
                      "type": "string",
                      "description": "Auto GUID field."
                    },
                    {
                      "name": "DetectedUtc",
                      "type": "datetime",
                      "description": "UTC timestamp at which the event was detected."
                    },
                    {
                      "name": "ReceivedUtc",
                      "type": "datetime",
                      "description": "UTC timestamp at which the event was received."
                    },
                    {
                      "name": "AgentGuid",
                      "type": "string",
                      "description": "GUID of the agent."
                    },
                    {
                      "name": "Analyzer",
                      "type": "string",
                      "description": "Analyzer information."
                    },
                    {
                      "name": "AnalyzerName",
                      "type": "string",
                      "description": "Name of the analyzer."
                    },
                    {
                      "name": "AnalyzerVersion",
                      "type": "string",
                      "description": "Version of the analyzer."
                    },
                    {
                      "name": "AnalyzerHostName",
                      "type": "string",
                      "description": "Host name of the analyzer."
                    },
                    {
                      "name": "AnalyzerIPv4",
                      "type": "string",
                      "description": "IPv4 address of the analyzer."
                    },
                    {
                      "name": "AnalyzerIPv6",
                      "type": "string",
                      "description": "IPv6 address of the analyzer."
                    },
                    {
                      "name": "AnalyzerMac",
                      "type": "string",
                      "description": "MAC address of the analyzer."
                    },
                    {
                      "name": "AnalyzerDatVersion",
                      "type": "string",
                      "description": "DAT version of the analyzer."
                    },
                    {
                      "name": "AnalyzerEngineVersion",
                      "type": "string",
                      "description": "Engine version of the analyzer."
                    },
                    {
                      "name": "AnalyzerDetectionMethod",
                      "type": "string",
                      "description": "Detection method of the analyzer."
                    },
                    {
                      "name": "SourceHostName",
                      "type": "string",
                      "description": "Host name of the event source."
                    },
                    {
                      "name": "SourceIPv4",
                      "type": "string",
                      "description": "IPv4 address of the event source."
                    },
                    {
                      "name": "SourceIPv6",
                      "type": "string",
                      "description": "IPv6 address of the event source."
                    },
                    {
                      "name": "SourceMac",
                      "type": "string",
                      "description": "MAC address of the event source."
                    },
                    {
                      "name": "SourceUserName",
                      "type": "string",
                      "description": "User name of the event source."
                    },
                    {
                      "name": "SourceProcessName",
                      "type": "string",
                      "description": "Process name of the event source."
                    },
                    {
                      "name": "SourceUrl",
                      "type": "string",
                      "description": "URL of the event source."
                    },
                    {
                      "name": "TargetHostName",
                      "type": "string",
                      "description": "Host name of the event target."
                    },
                    {
                      "name": "TargetIPv4",
                      "type": "string",
                      "description": "IPv4 address of the event target."
                    },
                    {
                      "name": "TargetIPv6",
                      "type": "string",
                      "description": "IPv6 address of the event target."
                    },
                    {
                      "name": "TargetMac",
                      "type": "string",
                      "description": "MAC address of the event target."
                    },
                    {
                      "name": "TargetUserName",
                      "type": "string",
                      "description": "User name of the event target."
                    },
                    {
                      "name": "TargetPort",
                      "type": "string",
                      "description": "Port of the event target."
                    },
                    {
                      "name": "TargetProtocol",
                      "type": "string",
                      "description": "Protocol of the event target."
                    },
                    {
                      "name": "TargetProcessName",
                      "type": "string",
                      "description": "Process name of the event target."
                    },
                    {
                      "name": "TargetFileName",
                      "type": "string",
                      "description": "File name of the event target."
                    },
                    {
                      "name": "ThreatCategory",
                      "type": "string",
                      "description": "Category of the threat."
                    },
                    {
                      "name": "ThreatEventId",
                      "type": "int",
                      "description": "ID of the threat event."
                    },
                    {
                      "name": "ThreatSeverity",
                      "type": "string",
                      "description": "Severity of the threat."
                    },
                    {
                      "name": "ThreatName",
                      "type": "string",
                      "description": "Name of the threat."
                    },
                    {
                      "name": "ThreatType",
                      "type": "string",
                      "description": "Type of the threat."
                    },
                    {
                      "name": "ThreatActionTaken",
                      "type": "string",
                      "description": "Action taken for the threat."
                    },
                    {
                      "name": "ThreatHandled",
                      "type": "boolean",
                      "description": "Indicates if the threat was handled."
                    },
                    {
                      "name": "Timestamp",
                      "type": "datetime",
                      "description": "Timestamp of the event."
                    },
                    {
                      "name": "NodePath",
                      "type": "string",
                      "description": "Path of the node."
                    },
                    {
                      "name": "TargetHash",
                      "type": "string",
                      "description": "Hash of the event target."
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "TrellixConnector",
          "title": "Trellix Endpoint Security (via Codeless Connector Framework)",
          "publisher": "Microsoft",
          "descriptionMarkdown": "The [Trellix Endpoint Security](https://www.trellix.com/) data connector enables you to ingest security events from Trellix ePO (ePolicy Orchestrator) into Microsoft Sentinel. This connector uses OAuth2 client credentials authentication and automatically handles pagination to collect comprehensive endpoint security data including threat detections, analyzer information, source and target system details, and threat response actions.",
          "graphQueriesTableName": "TrellixEvents",
          "graphQueries": [
            {
              "metricName": "Trellix events",
              "legend": "Trellix ePO Events",
              "baseQuery": "TrellixEvents"
            }
          ],
          "sampleQueries": [
            {
              "description": "All Trellix events",
              "query": "{{graphQueriesTableName}}\n| sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "TrellixEvents",
              "lastDataReceivedQuery": "TrellixEvents\n| where TimeGenerated > ago(6h)\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            },
            {
              "type": "IsConnectedQuery",
              "value": [
                "TrellixEvents | where TimeGenerated > ago(1h) | take 1"
              ]
            }
          ],
          "availability": {
            "isPreview": true,
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true,
                  "action": false
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. API Configuration",
              "description": "Configure your Trellix ePO API connection.",
              "instructions": [
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "API Base URL",
                    "placeholder": "https://api.manage.trellix.com",
                    "type": "text",
                    "name": "trellixApiBaseUrl",
                    "validations": {
                      "required": true
                    }
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "## Authentication\n\nProvide your API key for authentication. This will be sent in the x-api-key header."
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "API Key",
                    "placeholder": "Enter your API key",
                    "type": "password",
                    "name": "apiKey",
                    "validations": {
                      "required": true
                    }
                  }
                },
                {
                  "type": "InfoMessage",
                  "parameters": {
                    "text": "The API key will be securely stored and used for authentication with the Trellix ePO API.",
                    "visible": true,
                    "inline": true
                  }
                }
              ]
            },
            {
              "title": "2. Authentication Configuration",
              "description": "Configure OAuth2 authentication credentials.",
              "instructions": [
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Token endpoint",
                    "placeholder": "https://iam.cloud.trellix.com/iam/v1.0/token",
                    "type": "text",
                    "name": "trellixAuthTokenUrl",
                    "validations": {
                      "required": true
                    }
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "### OAuth2 Configuration\nConfigure OAuth2 client credentials for API access. Read about the Trellix API authorization model at https://developer.manage.trellix.com/public/mvision/docs/umam"
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Client ID",
                    "placeholder": "Your client ID",
                    "type": "text",
                    "name": "clientId",
                    "validations": {
                      "required": true
                    }
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Client Secret",
                    "placeholder": "Your client secret",
                    "type": "password",
                    "name": "clientSecret",
                    "validations": {
                      "required": true
                    }
                  }
                },
                {
                  "type": "InfoMessage",
                  "parameters": {
                    "text": "OAuth2 authentication provides secure access to your API endpoints.",
                    "visible": true,
                    "inline": true
                  }
                }
              ]
            },
            {
              "title": "3. Enable Connector",
              "description": "Activate the Trellix Endpoint Security connector",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "### Connector Activation\n\nReview your configuration and enable the connector to start collecting security events."
                  }
                },
                {
                  "type": "ConnectionToggleButton",
                  "parameters": {
                    "connectLabel": "Connect Trellix Endpoint Security",
                    "disconnectLabel": "Disconnect Connector",
                    "name": "mainToggle"
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "### Post-Connection\n\nAfter connecting, monitor the connector status in the **Data connectors** page. Data should begin appearing within 5-10 minutes."
                  }
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "Trellix Endpoint Security (via Codeless Connector Framework)",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "connectorDefinitionName": {
              "defaultValue": "Trellix Endpoint Security (via Codeless Connector Framework)",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "trellixApiBaseUrl": {
              "defaultValue": "trellixApiBaseUrl",
              "type": "securestring",
              "minLength": 1
            },
            "apiKey": {
              "defaultValue": "apiKey",
              "type": "securestring",
              "minLength": 1
            },
            "trellixAuthTokenUrl": {
              "defaultValue": "trellixAuthTokenUrl",
              "type": "securestring",
              "minLength": 1
            },
            "clientId": {
              "defaultValue": "clientId",
              "type": "securestring",
              "minLength": 1
            },
            "clientSecret": {
              "defaultValue": "clientSecret",
              "type": "securestring",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'TrellixPoller', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "auth": {
                  "type": "OAuth2",
                  "ClientId": "clientId",
                  "ClientSecret": "clientSecret",
                  "GrantType": "client_credentials",
                  "TokenEndpoint": "[[parameters('trellixAuthTokenUrl')]",
                  "Scope": "epo.device.r epo.device.w epo.tags.r epo.tags.w epo.evt.r",
                  "TokenEndpointHeaders": {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Authorization": "[[concat('Basic ',base64(concat(parameters('clientId'),':',parameters('clientSecret'))))]"
                  }
                },
                "request": {
                  "apiEndpoint": "[[concat(parameters('trellixApiBaseUrl'), '/epo/v2/events')]",
                  "httpMethod": "GET",
                  "rateLimitQPS": 3,
                  "queryWindowInMin": 30,
                  "retryCount": 3,
                  "timeoutInSeconds": 30,
                  "headers": {
                    "User-Agent": "MS-Sentinel-CCF-Trellix",
                    "Content-Type": "application/vnd.api+json",
                    "Accept": "application/json",
                    "x-api-key": "[[parameters('apiKey')]"
                  },
                  "queryParameters": {
                    "page[limit]": "1000",
                    "sort": "timestamp",
                    "filter[timestamp][GE]": "{_QueryWindowStartTime}"
                  }
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.data[*]"
                  ],
                  "format": "json"
                },
                "paging": {
                  "pagingType": "NextPageUrl",
                  "nextPageUrl": "[[parameters('trellixApiBaseUrl')]",
                  "nextPageTokenJsonPath": "$.links.next",
                  "isNextPageTokenRelativeUrl": true
                },
                "connectorDefinitionName": "TrellixConnector",
                "dataType": "TrellixEvents",
                "dcrConfig": {
                  "streamName": "Custom-TrellixEvents_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserObject1').parserTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "TrellixEvents Data Parser with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserObject1').parserVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('parserObject1')._parserName1]",
              "apiVersion": "2025-07-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "TrellixEventsAliasFunction",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "TrellixEvents",
                "query": "union isfuzzy=true TrellixEvents_CL, SentinelTrellixEvents\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject1')._parserId1,'/'))))]",
              "dependsOn": [
                "[variables('parserObject1')._parserId1]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'TrellixEvents')]",
                "contentId": "[variables('parserObject1').parserContentId1]",
                "kind": "Parser",
                "version": "[variables('parserObject1').parserVersion1]",
                "source": {
                  "name": "Trellix",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('parserObject1').parserContentId1]",
        "contentKind": "Parser",
        "displayName": "TrellixEventsAliasFunction",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', '1.0.0')))]",
        "version": "[variables('parserObject1').parserVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2025-07-01",
      "name": "[variables('parserObject1')._parserName1]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "TrellixEventsAliasFunction",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "TrellixEvents",
        "query": "union isfuzzy=true TrellixEvents_CL, SentinelTrellixEvents\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject1')._parserId1,'/'))))]",
      "dependsOn": [
        "[variables('parserObject1')._parserId1]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'TrellixEvents')]",
        "contentId": "[variables('parserObject1').parserContentId1]",
        "kind": "Parser",
        "version": "[variables('parserObject1').parserVersion1]",
        "source": {
          "kind": "Solution",
          "name": "Trellix",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Trellix",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Trellix/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://www.trellix.com/products/epo/\">Trellix</a> solution for Microsoft Sentinel enables you to ingest Trellix ePO events into Microsoft Sentinel.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<p> <a href=\"https://aka.ms/Sentinel-CCP_Platform\">Microsoft Sentinel Codeless Connector Framework</a></p>\n<p><strong>Data Connectors:</strong> 1, <strong>Parsers:</strong> 1</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Azure_Sentinel.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Trellix",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('parserObject1').parserContentId1]",
              "version": "[variables('parserObject1').parserVersion1]"
            }
          ]
        },
        "firstPublishDate": "2026-02-26",
        "providers": [
          "Trellix"
        ],
        "categories": {
          "domains": [
            "Application"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
